{% extends "base.html" %} {% block content %}
<!-- Main Content -->
<main class="container chat-container">
  <div class="card">
    <div class="card-header">
      <h2 class="card-title">Chat con el Asistente</h2>
    </div>
    <div class="card-body">
      <!-- Contenedor del chat -->
      <div class="chat-box">
        <div class="chat-messages" id="chat-container">
          {% for msg in messages %}
          <div class="message">
            <div class="message-avatar">U</div>
            <div class="message-content">{{ msg.prompt }}</div>
          </div>
          <div class="message bot">
            <div class="message-avatar">A</div>
            <div class="message-content">{{ msg.response }}</div>
          </div>
          {% endfor %}
        </div>

        <div class="chat-input-container">
          <form id="chat-form" class="chat-input-form">
            <input
              type="text"
              name="prompt"
              id="prompt"
              class="chat-input"
              placeholder="Escribe tu pregunta..."
              required
            />
            <label style="display: flex; align-items: center; gap: 0.5rem">
              <input type="checkbox" id="stream-mode" />
              Streaming
            </label>
            <button type="submit" class="chat-send-btn">Enviar</button>
          </form>
        </div>
      </div>
    </div>
    <div class="card-footer">
      <button id="send-full-feedback" class="btn btn-secondary w-full">
        ðŸ’¬ Enviar Feedback
      </button>
      <div id="feedback-status" class="mt-sm"></div>
    </div>
  </div>
</main>
{% endblock %} {% block extra_js %}
<script>
  // EnvÃ­o del mensaje del usuario y la respuesta del modelo
  document
    .getElementById("chat-form")
    .addEventListener("submit", async function (e) {
      e.preventDefault();
      const promptInput = document.getElementById("prompt");
      const streamMode = document.getElementById("stream-mode").checked;
      const prompt = promptInput.value.trim();
      if (prompt === "") return;

      const chatContainer = document.getElementById("chat-container");

      // Agregar mensaje del usuario
      const userMessage = document.createElement("div");
      userMessage.className = "message user";
      userMessage.innerHTML =
        '<div class="message-avatar">U</div><div class="message-content">' +
        prompt +
        "</div>";
      chatContainer.appendChild(userMessage);
      promptInput.value = "";

      // Crear div para respuesta del bot
      const botMessage = document.createElement("div");
      botMessage.className = "message";
      const botAvatar = document.createElement("div");
      botAvatar.className = "message-avatar";
      botAvatar.innerText = "A";
      const messageContent = document.createElement("div");
      messageContent.className = "message-content";
      botMessage.appendChild(botAvatar);
      botMessage.appendChild(messageContent);
      chatContainer.appendChild(botMessage);

      // Scroll automÃ¡tico
      chatContainer.scrollTop = chatContainer.scrollHeight;

      try {
        if (streamMode) {
          // Modo streaming SSE
          const response = await fetch("/predict", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              prompt: prompt,
              stream: true,
              max_length: 50,
              num_return_sequences: 1,
              temperature: 0.7,
            }),
          });

          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let buffer = "";

          while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split("\n");
            buffer = lines.pop(); // Guardar lÃ­nea incompleta

            for (const line of lines) {
              if (line.startsWith("data: ")) {
                const data = line.slice(6);
                if (data === "[DONE]") {
                  break;
                }
                messageContent.innerText += data + " ";
                chatContainer.scrollTop = chatContainer.scrollHeight;
              }
            }
          }
        } else {
          // Modo normal (sin streaming)
          const response = await fetch("/predict", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              prompt: prompt,
              stream: false,
              max_length: 50,
              num_return_sequences: 1,
              temperature: 0.7,
            }),
          });
          const data = await response.json();
          if (data.generated_text) {
            messageContent.innerText = data.generated_text;
          } else {
            messageContent.innerText = "Error: " + (data.detail || "Unknown");
          }
        }
        chatContainer.scrollTop = chatContainer.scrollHeight;
      } catch (err) {
        messageContent.innerText = "Error: " + err;
      }
    });

  // FunciÃ³n para enviar la conversaciÃ³n completa como feedback
  document
    .getElementById("send-full-feedback")
    .addEventListener("click", async function () {
      const chatContainer = document.getElementById("chat-container");
      // Recopilar el texto de cada mensaje en el contenedor
      const messages = Array.from(
        chatContainer.getElementsByClassName("message")
      )
        .map((msg) => msg.innerText)
        .join("\n");

      const feedbackStatus = document.getElementById("feedback-status");
      feedbackStatus.innerHTML =
        '<span class="badge badge-info">Enviando...</span>';

      try {
        // Enviar la conversaciÃ³n al endpoint `/feedback`
        const response = await fetch("/feedback", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ text: messages }),
        });
        const data = await response.json();
        if (response.ok) {
          feedbackStatus.innerHTML =
            '<span class="badge badge-success">Feedback enviado âœ“</span>';
        } else {
          feedbackStatus.innerHTML =
            '<span class="badge badge-error">Error: ' +
            (data.detail || data.error) +
            "</span>";
        }
      } catch (err) {
        feedbackStatus.innerHTML =
          '<span class="badge badge-error">Error: ' + err + "</span>";
      }
    });
</script>
{% endblock %}
