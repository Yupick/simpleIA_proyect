{% extends "admin_layout.html" %} {% block title %}Providers - Panel Admin{%
endblock %} {% block content %}
<div class="admin-header">
  <h1 class="admin-header-title">üîå Gesti√≥n de Providers</h1>
  <div class="admin-header-actions">
    <button class="btn btn-primary" onclick="loadProviders()">
      üîÑ Actualizar
    </button>
  </div>
</div>

<!-- Provider Actual -->
<div class="card">
  <div class="card-header">
    <h3 class="card-title">Provider Actual</h3>
  </div>
  <div class="card-body">
    <div class="row">
      <div class="col-md-6">
        <div class="form-group">
          <label class="form-label">Provider:</label>
          <p
            id="currentProvider"
            style="font-size: 1.2rem; font-weight: bold; color: #4a90e2"
          >
            Cargando...
          </p>
        </div>
      </div>
      <div class="col-md-6">
        <div class="form-group">
          <label class="form-label">Modelo:</label>
          <p
            id="currentModel"
            style="font-size: 1.2rem; font-weight: bold; color: #4a90e2"
          >
            Cargando...
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Cambiar Provider -->
<div class="card mt-lg">
  <div class="card-header">
    <h3 class="card-title">Cambiar Provider</h3>
  </div>
  <div class="card-body">
    <form onsubmit="switchProvider(event)">
      <div class="row">
        <div class="col-md-6">
          <div class="form-group">
            <label class="form-label">Nuevo Provider</label>
            <select
              id="newProvider"
              class="form-control"
              required
              onchange="updateProviderFields()"
            >
              <option value="">Seleccione un provider...</option>
              <option value="huggingface">HuggingFace (Gratuito)</option>
              <option value="claude">Claude (Anthropic)</option>
              <option value="openai">OpenAI</option>
            </select>
          </div>
        </div>
        <div class="col-md-6">
          <div class="form-group">
            <label class="form-label">Modelo</label>
            <select id="newModel" class="form-control" required>
              <option value="">Primero selecciona un provider...</option>
            </select>
            <small
              id="modelHint"
              style="color: #657786; display: block; margin-top: 5px"
            ></small>
          </div>
        </div>
      </div>

      <!-- Campos din√°micos para API Keys -->
      <div id="apiKeyFields" style="display: none">
        <div class="row">
          <div class="col-md-12">
            <div class="form-group">
              <label class="form-label" id="apiKeyLabel">API Key</label>
              <input
                type="password"
                id="apiKey"
                class="form-control"
                placeholder="sk-..."
              />
              <small style="color: #657786">
                Obt√©n tu API key aqu√≠:
                <a
                  id="apiKeyLink"
                  href="#"
                  target="_blank"
                  style="color: #4a90e2; font-weight: bold"
                  >Ver documentaci√≥n</a
                >
              </small>
            </div>
          </div>
        </div>

        <!-- Campos adicionales para Claude -->
        <div id="claudeFields" style="display: none">
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label class="form-label">API Version (opcional)</label>
                <input
                  type="text"
                  id="apiVersion"
                  class="form-control"
                  placeholder="2023-06-01"
                  value="2023-06-01"
                />
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label class="form-label">Max Tokens (opcional)</label>
                <input
                  type="number"
                  id="maxTokens"
                  class="form-control"
                  placeholder="4096"
                  value="4096"
                />
              </div>
            </div>
          </div>
        </div>

        <!-- Campos adicionales para OpenAI -->
        <div id="openaiFields" style="display: none">
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label class="form-label">Organization ID (opcional)</label>
                <input
                  type="text"
                  id="orgId"
                  class="form-control"
                  placeholder="org-..."
                />
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label class="form-label">Base URL (opcional)</label>
                <input
                  type="text"
                  id="baseUrl"
                  class="form-control"
                  placeholder="https://api.openai.com/v1"
                />
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="alert alert-warning mt-md">
        ‚ö†Ô∏è <strong>Importante:</strong> Cambiar el provider
        <strong>reiniciar√° autom√°ticamente la API</strong> para aplicar los
        cambios. El proceso tomar√° unos segundos.
      </div>

      <button type="submit" class="btn btn-primary" id="switchBtn">
        üîÑ Cambiar Provider y Reiniciar
      </button>
    </form>
  </div>
</div>

<!-- Providers Disponibles -->
<div class="card mt-lg">
  <div class="card-header">
    <h3 class="card-title">Providers Disponibles</h3>
  </div>
  <div class="card-body">
    <div class="row">
      <div class="col-md-4">
        <div class="card" style="border: 2px solid #4a90e2">
          <div class="card-body">
            <h4>ü§ó HuggingFace</h4>
            <p>Modelos open-source gratuitos</p>
            <ul style="font-size: 0.9rem; color: #657786">
              <li>gpt2</li>
              <li>gpt2-medium</li>
              <li>distilgpt2</li>
              <li>flax-community/gpt-2-spanish</li>
            </ul>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card" style="border: 2px solid #d97706">
          <div class="card-body">
            <h4>üß† Claude</h4>
            <p>Anthropic AI (Requiere API Key)</p>
            <ul style="font-size: 0.9rem; color: #657786">
              <li>claude-3-opus</li>
              <li>claude-3-sonnet</li>
              <li>claude-3-haiku</li>
            </ul>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card" style="border: 2px solid #10b981">
          <div class="card-body">
            <h4>‚ö° OpenAI</h4>
            <p>GPT Models (Requiere API Key)</p>
            <ul style="font-size: 0.9rem; color: #657786">
              <li>gpt-4</li>
              <li>gpt-4-turbo</li>
              <li>gpt-3.5-turbo</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Toast -->
<div
  id="toast"
  class="alert"
  style="
    position: fixed;
    top: 20px;
    right: 20px;
    display: none;
    z-index: 3000;
    min-width: 300px;
  "
></div>

{% endblock %} {% block extra_js %}
<script>
  function showToast(message, type = "success") {
    const toast = document.getElementById("toast");
    toast.textContent = message;
    toast.className = `alert alert-${type}`;
    toast.style.display = "block";
    setTimeout(() => (toast.style.display = "none"), 3000);
  }

  async function loadProviders() {
    try {
      const response = await fetch("/admin/providers/current", {
        credentials: "include",
      });

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        const errorMsg =
          errorData.error || errorData.detail || `Error ${response.status}`;
        console.error("Error loading current provider:", errorData);
        throw new Error(errorMsg);
      }

      const data = await response.json();
      console.log("Current provider data:", data);

      document.getElementById("currentProvider").textContent =
        data.provider || "No configurado";
      document.getElementById("currentModel").textContent =
        data.model || "No configurado";

      // Guardar las keys para pre-llenar campos
      window.savedKeys = data.saved_keys || {};
    } catch (error) {
      console.error("Error completo:", error);
      document.getElementById("currentProvider").textContent =
        "Error: " + error.message;
      document.getElementById("currentModel").textContent =
        "Error: " + error.message;
      showToast("Error al cargar provider actual: " + error.message, "error");
    }
  }

  // Actualizar campos seg√∫n provider seleccionado
  async function updateProviderFields() {
    const provider = document.getElementById("newProvider").value;
    const apiKeyFields = document.getElementById("apiKeyFields");
    const claudeFields = document.getElementById("claudeFields");
    const openaiFields = document.getElementById("openaiFields");
    const apiKeyLabel = document.getElementById("apiKeyLabel");
    const apiKeyLink = document.getElementById("apiKeyLink");
    const apiKeyInput = document.getElementById("apiKey");
    const modelSelect = document.getElementById("newModel");
    const modelHint = document.getElementById("modelHint");

    // Resetear todos los campos
    claudeFields.style.display = "none";
    openaiFields.style.display = "none";
    apiKeyInput.removeAttribute("required");
    modelSelect.innerHTML = '<option value="">Cargando modelos...</option>';
    modelHint.textContent = "";

    if (!provider) {
      modelSelect.innerHTML =
        '<option value="">Primero selecciona un provider...</option>';
      apiKeyFields.style.display = "none";
      return;
    }

    // Cargar modelos disponibles para el provider seleccionado
    try {
      const response = await fetch(
        `/admin/providers/models?provider=${provider}`,
        {
          credentials: "include",
        }
      );

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        const errorMsg =
          errorData.detail || errorData.error || `HTTP ${response.status}`;
        console.error("Error response:", errorData);
        throw new Error(errorMsg);
      }

      const data = await response.json();
      console.log("Models data received:", data);
      const models = data.models;

      // Validar que models existe
      if (!models) {
        throw new Error("La respuesta no contiene modelos");
      }

      // Poblar dropdown de modelos
      modelSelect.innerHTML =
        '<option value="">Selecciona un modelo...</option>';

      if (provider === "huggingface") {
        // Modelos HuggingFace por categor√≠a
        if (models.spanish && models.spanish.length > 0) {
          const optgroup = document.createElement("optgroup");
          optgroup.label = "üá™üá∏ Espa√±ol";
          models.spanish.forEach((model) => {
            const option = document.createElement("option");
            option.value = model.id;
            option.textContent = `${model.name} (${model.size})`;
            optgroup.appendChild(option);
          });
          modelSelect.appendChild(optgroup);
        }

        if (models.english && models.english.length > 0) {
          const optgroup = document.createElement("optgroup");
          optgroup.label = "üá¨üáß English";
          models.english.forEach((model) => {
            const option = document.createElement("option");
            option.value = model.id;
            option.textContent = `${model.name} (${model.size})`;
            optgroup.appendChild(option);
          });
          modelSelect.appendChild(optgroup);
        }

        if (models.multilingual && models.multilingual.length > 0) {
          const optgroup = document.createElement("optgroup");
          optgroup.label = "üåç Multiling√ºe";
          models.multilingual.forEach((model) => {
            const option = document.createElement("option");
            option.value = model.id;
            option.textContent = `${model.name} (${model.size})`;
            optgroup.appendChild(option);
          });
          modelSelect.appendChild(optgroup);
        }

        if (models.local && models.local.length > 0) {
          const optgroup = document.createElement("optgroup");
          optgroup.label = "üéì Modelos Entrenados Localmente";
          models.local.forEach((model) => {
            const option = document.createElement("option");
            option.value = model.id;
            option.textContent = model.name;
            optgroup.appendChild(option);
          });
          modelSelect.appendChild(optgroup);
        }

        modelHint.textContent =
          "Modelos gratuitos y open-source. Se descargan y ejecutan localmente. No requieren API key.";
        apiKeyFields.style.display = "none";
      } else {
        // Claude u OpenAI - lista simple
        if (!Array.isArray(models)) {
          console.error("Models no es un array:", models);
          throw new Error("Formato de modelos inv√°lido");
        }

        models.forEach((model) => {
          const option = document.createElement("option");
          option.value = model.id;
          option.textContent = `${model.name} (${model.cost || "N/A"})`;
          modelSelect.appendChild(option);
        });

        if (provider === "claude") {
          apiKeyFields.style.display = "block";
          claudeFields.style.display = "block";
          apiKeyLabel.textContent = "Anthropic API Key";
          apiKeyLink.href = "https://console.anthropic.com/account/keys";
          apiKeyInput.placeholder = "sk-ant-...";
          modelHint.textContent =
            "Requiere API key de Anthropic. Se ejecuta en la nube. Costo por tokens.";

          // Pre-llenar
          if (window.savedKeys) {
            apiKeyInput.value = window.savedKeys.anthropic_api_key || "";
            document.getElementById("apiVersion").value =
              window.savedKeys.api_version || "2023-06-01";
            document.getElementById("maxTokens").value =
              window.savedKeys.max_tokens || 4096;
            if (!window.savedKeys.anthropic_api_key) {
              apiKeyInput.setAttribute("required", "required");
            }
          }
        } else if (provider === "openai") {
          apiKeyFields.style.display = "block";
          openaiFields.style.display = "block";
          apiKeyLabel.textContent = "OpenAI API Key";
          apiKeyLink.href = "https://platform.openai.com/api-keys";
          apiKeyInput.placeholder = "sk-...";
          modelHint.textContent =
            "Requiere API key de OpenAI. Se ejecuta en la nube. Costo por tokens.";

          // Pre-llenar
          if (window.savedKeys) {
            apiKeyInput.value = window.savedKeys.openai_api_key || "";
            document.getElementById("orgId").value =
              window.savedKeys.organization_id || "";
            document.getElementById("baseUrl").value =
              window.savedKeys.base_url || "";
            if (!window.savedKeys.openai_api_key) {
              apiKeyInput.setAttribute("required", "required");
            }
          }
        }
      }
    } catch (error) {
      console.error("Error cargando modelos:", error);
      modelSelect.innerHTML =
        '<option value="">Error al cargar modelos</option>';
      showToast("Error al cargar lista de modelos", "error");
    }
  }

  async function switchProvider(event) {
    event.preventDefault();

    const switchBtn = document.getElementById("switchBtn");
    const originalText = switchBtn.innerHTML;
    switchBtn.disabled = true;
    switchBtn.innerHTML = "‚è≥ Cambiando provider y reiniciando API...";

    const provider = document.getElementById("newProvider").value;
    const model = document.getElementById("newModel").value;

    if (!provider || !model) {
      showToast("Por favor complete todos los campos", "error");
      switchBtn.disabled = false;
      switchBtn.innerHTML = originalText;
      return;
    }

    // Preparar datos
    const data = {
      provider: provider,
      model: model,
    };

    // Agregar API key y campos adicionales seg√∫n provider
    if (provider === "claude") {
      const apiKey = document.getElementById("apiKey").value;
      if (!apiKey) {
        showToast(
          "La API key de Anthropic es requerida para usar Claude",
          "error"
        );
        switchBtn.disabled = false;
        switchBtn.innerHTML = originalText;
        return;
      }
      data.api_key = apiKey;
      data.api_version =
        document.getElementById("apiVersion").value || "2023-06-01";
      data.max_tokens =
        parseInt(document.getElementById("maxTokens").value) || 4096;
    } else if (provider === "openai") {
      const apiKey = document.getElementById("apiKey").value;
      if (!apiKey) {
        showToast("La API key de OpenAI es requerida", "error");
        switchBtn.disabled = false;
        switchBtn.innerHTML = originalText;
        return;
      }
      data.api_key = apiKey;
      const orgId = document.getElementById("orgId").value;
      const baseUrl = document.getElementById("baseUrl").value;
      if (orgId) data.organization_id = orgId;
      if (baseUrl) data.base_url = baseUrl;
    }

    try {
      const response = await fetch("/admin/providers/switch", {
        method: "POST",
        credentials: "include",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(data),
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.detail || "Error al cambiar provider");
      }

      const result = await response.json();
      showToast(
        result.message ||
          "Provider cambiado exitosamente. La API se reiniciar√° autom√°ticamente...",
        "success"
      );

      // Esperar 3 segundos y recargar para mostrar nuevo provider
      setTimeout(() => {
        location.reload();
      }, 3000);
    } catch (error) {
      console.error("Error:", error);
      showToast("Error al cambiar provider: " + error.message, "error");
      switchBtn.disabled = false;
      switchBtn.innerHTML = originalText;
    }
  }

  document.addEventListener("DOMContentLoaded", loadProviders);
</script>
{% endblock %}
