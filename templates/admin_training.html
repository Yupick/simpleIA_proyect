{% extends "admin_layout.html" %} {% block title %}Entrenamiento - Panel Admin{%
endblock %} {% block content %}
<div class="admin-header">
  <h1 class="admin-header-title">üéì Entrenamiento del Modelo</h1>
  <div class="admin-header-actions">
    <button class="btn btn-secondary" onclick="location.reload()">
      üîÑ Actualizar
    </button>
  </div>
</div>

<!-- Informaci√≥n -->
<div class="alert alert-info">
  ‚ÑπÔ∏è <strong>Nota:</strong> El entrenamiento de modelos LLM es un proceso
  complejo que requiere recursos computacionales significativos. Esta secci√≥n
  permite configurar y ejecutar procesos de fine-tuning cuando el modelo lo
  soporte.
</div>

<!-- Subir archivos de entrenamiento -->
<div class="card">
  <div class="card-header">
    <h3 class="card-title">üìÅ Archivos de Entrenamiento</h3>
  </div>
  <div class="card-body">
    <div class="row">
      <div class="col-md-6">
        <div class="form-group">
          <label class="form-label">Archivo de Di√°logos</label>
          <div
            class="file-upload-zone"
            onclick="document.getElementById('dialogueFile').click()"
          >
            <div class="file-upload-icon">üìÑ</div>
            <p class="file-upload-text">
              Click para seleccionar archivo de di√°logos
            </p>
            <p class="file-upload-hint">
              Formatos: .txt, .pdf, .csv, .json, .xlsx, .xls, .docx
            </p>
          </div>
          <input
            type="file"
            id="dialogueFile"
            accept=".txt,.pdf,.csv,.json,.xlsx,.xls,.docx"
            style="display: none"
            onchange="uploadFile(event, 'dialogue')"
          />
          <div id="dialogueStatus" class="mt-sm"></div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="form-group">
          <label class="form-label">Archivo de Conocimiento</label>
          <div
            class="file-upload-zone"
            onclick="document.getElementById('knowledgeFile').click()"
          >
            <div class="file-upload-icon">üìö</div>
            <p class="file-upload-text">
              Click para seleccionar archivo de conocimiento
            </p>
            <p class="file-upload-hint">
              Formatos: .txt, .pdf, .csv, .json, .xlsx, .xls, .docx
            </p>
          </div>
          <input
            type="file"
            id="knowledgeFile"
            accept=".txt,.pdf,.csv,.json,.xlsx,.xls,.docx"
            style="display: none"
            onchange="uploadFile(event, 'knowledge')"
          />
          <div id="knowledgeStatus" class="mt-sm"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Configuraci√≥n de entrenamiento -->
<div class="card mt-lg">
  <div class="card-header">
    <h3 class="card-title">‚öôÔ∏è Configuraci√≥n de Entrenamiento</h3>
  </div>
  <div class="card-body">
    <form id="trainingForm">
      <div class="row">
        <div class="col-md-6">
          <div class="form-group">
            <label class="form-label">Modelo Base</label>
            <select class="form-control" id="modelName">
              <option value="">Cargando modelos...</option>
            </select>
            <small>Modelo base de HuggingFace para fine-tuning</small>
          </div>
        </div>

        <div class="col-md-6">
          <div class="form-group">
            <label class="form-label">Fuente de Datos</label>
            <select class="form-control" id="dataSource">
              <option value="all">
                Todos los archivos (Di√°logos + Conocimiento)
              </option>
              <option value="dialogue">Solo Di√°logos</option>
              <option value="knowledge">Solo Conocimiento</option>
            </select>
            <small>Seleccionar qu√© archivos usar para entrenamiento</small>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-3">
          <div class="form-group">
            <label class="form-label">√âpocas (Epochs)</label>
            <input
              type="number"
              class="form-control"
              id="epochs"
              value="3"
              min="1"
              max="100"
            />
            <small>N√∫mero de veces que se procesa el dataset completo</small>
          </div>
        </div>

        <div class="col-md-3">
          <div class="form-group">
            <label class="form-label">Batch Size</label>
            <input
              type="number"
              class="form-control"
              id="batchSize"
              value="4"
              min="1"
              max="64"
            />
            <small>Tama√±o del lote de datos por iteraci√≥n</small>
          </div>
        </div>

        <div class="col-md-3">
          <div class="form-group">
            <label class="form-label">Learning Rate</label>
            <input
              type="number"
              class="form-control"
              id="learningRate"
              value="0.00005"
              step="0.00001"
              min="0.00001"
              max="0.1"
            />
            <small>Tasa de aprendizaje del modelo</small>
          </div>
        </div>

        <div class="col-md-3">
          <div class="form-group">
            <label class="form-label">Max Length</label>
            <input
              type="number"
              class="form-control"
              id="maxLength"
              value="128"
              min="32"
              max="1024"
            />
            <small>Longitud m√°xima de tokens</small>
          </div>
        </div>
      </div>

      <div class="alert alert-warning mt-md">
        ‚ö†Ô∏è <strong>Advertencia:</strong> El entrenamiento puede tomar varios
        minutos u horas dependiendo del tama√±o del dataset y los recursos
        disponibles.
      </div>

      <div class="row">
        <div class="col-md-6">
          <button
            type="button"
            class="btn btn-primary"
            onclick="startTraining()"
            id="startTrainingBtn"
            style="width: 100%"
          >
            üöÄ Iniciar Entrenamiento
          </button>
        </div>
        <div class="col-md-6">
          <button
            type="button"
            class="btn btn-danger"
            onclick="cancelTraining()"
            id="cancelTrainingBtn"
            style="width: 100%; display: none"
          >
            ‚õî Cancelar Entrenamiento
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Archivos Cargados -->
<div class="card mt-lg">
  <div class="card-header">
    <h3 class="card-title">üìÇ Archivos Cargados</h3>
  </div>
  <div class="card-body">
    <div class="row">
      <div class="col-md-6">
        <h4>Di√°logos</h4>
        <div id="dialogueFilesList" style="max-height: 200px; overflow-y: auto">
          <p class="text-muted">Cargando...</p>
        </div>
      </div>
      <div class="col-md-6">
        <h4>Conocimiento</h4>
        <div
          id="knowledgeFilesList"
          style="max-height: 200px; overflow-y: auto"
        >
          <p class="text-muted">Cargando...</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Progreso del entrenamiento -->
<div class="card mt-lg" id="trainingProgress" style="display: none">
  <div class="card-header">
    <h3 class="card-title">‚è≥ Progreso del Entrenamiento</h3>
  </div>
  <div class="card-body">
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill" style="width: 0%"></div>
    </div>
    <p
      id="progressText"
      class="mt-sm"
      style="text-align: center; font-weight: bold"
    >
      0%
    </p>

    <div class="mt-md">
      <h4>Logs:</h4>
      <div
        id="trainingLogs"
        style="
          background: #1a1a1a;
          color: #00ff00;
          padding: 1rem;
          border-radius: 8px;
          font-family: monospace;
          max-height: 300px;
          overflow-y: auto;
        "
      >
        Esperando inicio...
      </div>
    </div>
  </div>
</div>

<!-- Historial de entrenamientos -->
<div class="card mt-lg">
  <div class="card-header">
    <h3 class="card-title">üìä Trabajos de Entrenamiento Recientes</h3>
  </div>
  <div class="card-body">
    <div id="trainingJobs">
      <p class="text-muted">Cargando trabajos...</p>
    </div>
  </div>
</div>

<!-- Toast -->
<div
  id="toast"
  class="alert"
  style="
    position: fixed;
    top: 20px;
    right: 20px;
    display: none;
    z-index: 3000;
    min-width: 300px;
  "
></div>

{% endblock %} {% block extra_js %}
<script>
  let currentJobId = null;
  let pollingInterval = null;

  function showToast(message, type = "success") {
    const toast = document.getElementById("toast");
    toast.textContent = message;
    toast.className = `alert alert-${type}`;
    toast.style.display = "block";
    setTimeout(() => (toast.style.display = "none"), 3000);
  }

  async function uploadFile(event, type) {
    const file = event.target.files[0];
    if (!file) {
      console.log("No file selected");
      return;
    }

    console.log(`Uploading file: ${file.name} (${file.size} bytes) to ${type}`);
    const statusDiv = document.getElementById(type + "Status");
    statusDiv.innerHTML = `<span class="badge badge-info">üì§ Subiendo ${file.name}...</span>`;

    try {
      const formData = new FormData();
      formData.append("file", file);

      console.log(`Posting to /training/upload/${type}`);
      const response = await fetch(`/training/upload/${type}`, {
        method: "POST",
        body: formData,
      });

      console.log(`Response status: ${response.status}`);
      const result = await response.json();
      console.log("Response data:", result);

      if (response.ok) {
        statusDiv.innerHTML = `<span class="badge badge-success">‚úì ${file.name} cargado</span>`;
        showToast(`Archivo ${file.name} subido exitosamente`, "success");
        console.log(`Reloading file list for ${type}`);
        await loadFiles(type);
      } else {
        throw new Error(
          result.detail || result.error || "Error al subir archivo"
        );
      }
    } catch (error) {
      console.error("Upload error:", error);
      statusDiv.innerHTML = `<span class="badge badge-danger">‚úó Error al subir</span>`;
      showToast(error.message, "danger");
    }
  }

  async function loadFiles(folder) {
    try {
      console.log(`Loading files from ${folder}...`);
      const response = await fetch(`/training/files/${folder}`);

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }

      const data = await response.json();
      console.log(`Files received for ${folder}:`, data);

      const listDiv = document.getElementById(`${folder}FilesList`);

      if (!listDiv) {
        console.error(`Element ${folder}FilesList not found`);
        return;
      }

      if (data.files && data.files.length > 0) {
        listDiv.innerHTML = data.files
          .map(
            (file) => `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; border-bottom: 1px solid #333;">
            <div>
              <strong>${file.name}</strong>
              <br>
              <small>${(file.size / 1024).toFixed(2)} KB - ${new Date(
              file.modified * 1000
            ).toLocaleString()}</small>
            </div>
            <button class="btn btn-sm btn-danger" onclick="deleteFile('${folder}', '${
              file.name
            }')">
              üóëÔ∏è Eliminar
            </button>
          </div>
        `
          )
          .join("");
        console.log(`Displayed ${data.files.length} files for ${folder}`);
      } else if (Array.isArray(data) && data.length > 0) {
        // Si data es un array directamente
        listDiv.innerHTML = data
          .map(
            (file) => `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; border-bottom: 1px solid #333;">
            <div>
              <strong>${file.name}</strong>
              <br>
              <small>${(file.size / 1024).toFixed(2)} KB - ${new Date(
              file.modified * 1000
            ).toLocaleString()}</small>
            </div>
            <button class="btn btn-sm btn-danger" onclick="deleteFile('${folder}', '${
              file.name
            }')">
              üóëÔ∏è Eliminar
            </button>
          </div>
        `
          )
          .join("");
        console.log(`Displayed ${data.length} files for ${folder}`);
      } else {
        listDiv.innerHTML =
          '<p class="text-muted">No hay archivos cargados</p>';
        console.log(`No files found for ${folder}`);
      }
    } catch (error) {
      console.error(`Error loading files for ${folder}:`, error);
      const listDiv = document.getElementById(`${folder}FilesList`);
      if (listDiv) {
        listDiv.innerHTML = `<p class="text-danger">Error al cargar archivos: ${error.message}</p>`;
      }
    }
  }

  async function deleteFile(folder, filename) {
    if (!confirm(`¬øEliminar el archivo ${filename}?`)) return;

    try {
      const response = await fetch(`/training/files/${folder}/${filename}`, {
        method: "DELETE",
      });

      const result = await response.json();

      if (response.ok) {
        showToast(`Archivo ${filename} eliminado`, "success");
        await loadFiles(folder);
      } else {
        throw new Error(result.detail || "Error al eliminar archivo");
      }
    } catch (error) {
      showToast(error.message, "danger");
    }
  }

  async function loadAvailableModels() {
    try {
      console.log("Cargando modelos disponibles...");
      const response = await fetch("/training/models/available");

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const data = await response.json();
      console.log("Modelos recibidos:", data);

      const modelSelect = document.getElementById("modelName");

      if (!modelSelect) {
        console.error("Elemento modelName no encontrado");
        return;
      }

      if (data.models && data.models.length > 0) {
        modelSelect.innerHTML = data.models
          .map((model) => `<option value="${model}">${model}</option>`)
          .join("");
        console.log(`${data.models.length} modelos cargados en el selector`);
      } else {
        modelSelect.innerHTML =
          '<option value="">No hay modelos disponibles</option>';
      }
    } catch (error) {
      console.error("Error cargando modelos:", error);
      const modelSelect = document.getElementById("modelName");
      if (modelSelect) {
        modelSelect.innerHTML =
          '<option value="">Error al cargar modelos</option>';
      }
    }
  }

  async function startTraining() {
    const modelName = document.getElementById("modelName").value;
    const epochs = parseInt(document.getElementById("epochs").value);
    const batchSize = parseInt(document.getElementById("batchSize").value);
    const learningRate = parseFloat(
      document.getElementById("learningRate").value
    );
    const maxLength = parseInt(document.getElementById("maxLength").value);
    const source = document.getElementById("dataSource").value;

    if (!modelName) {
      showToast("Por favor selecciona un modelo", "warning");
      return;
    }

    try {
      const response = await fetch("/training/start", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          model_name: modelName,
          epochs,
          batch_size: batchSize,
          learning_rate: learningRate,
          max_length: maxLength,
          source,
        }),
      });

      const result = await response.json();

      if (response.ok) {
        currentJobId = result.job_id;
        showToast("Entrenamiento iniciado", "success");

        // Mostrar progreso y deshabilitar bot√≥n
        document.getElementById("trainingProgress").style.display = "block";
        document.getElementById("startTrainingBtn").style.display = "none";
        document.getElementById("cancelTrainingBtn").style.display = "block";

        // Iniciar polling
        startPolling();
      } else {
        throw new Error(result.detail || "Error al iniciar entrenamiento");
      }
    } catch (error) {
      showToast(error.message, "danger");
    }
  }

  function startPolling() {
    if (pollingInterval) clearInterval(pollingInterval);

    pollingInterval = setInterval(async () => {
      if (!currentJobId) return;

      try {
        const response = await fetch(`/training/jobs/${currentJobId}`);
        const job = await response.json();

        // Actualizar barra de progreso
        const progressFill = document.getElementById("progressFill");
        const progressText = document.getElementById("progressText");
        progressFill.style.width = job.progress + "%";
        progressText.textContent = job.progress + "%";

        // Actualizar logs
        const logsDiv = document.getElementById("trainingLogs");
        logsDiv.innerHTML = job.logs.join("\n");
        logsDiv.scrollTop = logsDiv.scrollHeight;

        // Si termin√≥, detener polling
        if (
          job.status === "completed" ||
          job.status === "failed" ||
          job.status === "cancelled"
        ) {
          clearInterval(pollingInterval);
          pollingInterval = null;
          currentJobId = null;

          document.getElementById("startTrainingBtn").style.display = "block";
          document.getElementById("cancelTrainingBtn").style.display = "none";

          if (job.status === "completed") {
            showToast("‚úì Entrenamiento completado exitosamente", "success");
          } else if (job.status === "failed") {
            showToast("‚úó Entrenamiento fallido", "danger");
          } else if (job.status === "cancelled") {
            showToast("Entrenamiento cancelado", "warning");
          }

          await loadTrainingJobs();
        }
      } catch (error) {
        console.error("Error en polling:", error);
      }
    }, 2000); // Poll cada 2 segundos
  }

  async function cancelTraining() {
    if (!currentJobId) return;

    if (!confirm("¬øCancelar el entrenamiento en curso?")) return;

    try {
      const response = await fetch(`/training/jobs/${currentJobId}/cancel`, {
        method: "POST",
      });

      const result = await response.json();

      if (response.ok) {
        showToast("Entrenamiento cancelado", "warning");
      } else {
        throw new Error(result.detail || "Error al cancelar");
      }
    } catch (error) {
      showToast(error.message, "danger");
    }
  }

  async function loadTrainingJobs() {
    try {
      const response = await fetch("/training/jobs");
      const data = await response.json();

      const jobsDiv = document.getElementById("trainingJobs");

      if (data.jobs && data.jobs.length > 0) {
        jobsDiv.innerHTML = data.jobs
          .map((job) => {
            const statusBadge =
              {
                pending: "badge-secondary",
                running: "badge-info",
                completed: "badge-success",
                failed: "badge-danger",
                cancelled: "badge-warning",
              }[job.status] || "badge-secondary";

            return `
            <div style="padding: 1rem; border: 1px solid #333; border-radius: 8px; margin-bottom: 1rem;">
              <div style="display: flex; justify-content: space-between;">
                <div>
                  <strong>${job.model_name}</strong>
                  <span class="badge ${statusBadge}">${job.status}</span>
                </div>
                <div>
                  <small>${new Date(job.created_at).toLocaleString()}</small>
                </div>
              </div>
              <div style="margin-top: 0.5rem;">
                <small>Job ID: ${job.job_id}</small><br>
                <small>Progreso: ${job.progress}%</small>
              </div>
            </div>
          `;
          })
          .join("");
      } else {
        jobsDiv.innerHTML =
          '<p class="text-muted">No hay trabajos de entrenamiento</p>';
      }
    } catch (error) {
      console.error("Error cargando trabajos:", error);
      document.getElementById("trainingJobs").innerHTML =
        '<p class="text-danger">Error al cargar trabajos</p>';
    }
  }

  // Inicializaci√≥n
  document.addEventListener("DOMContentLoaded", async () => {
    await loadAvailableModels();
    await loadFiles("dialogue");
    await loadFiles("knowledge");
    await loadTrainingJobs();

    showToast("Panel de entrenamiento activo", "info");
  });
</script>
{% endblock %}
